generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

////////////////////////////////////
// ENUM
////////////////////////////////////

enum Role {
  STUDENT
  ADMIN
}

enum AdjustmentType {
  CANCELED   // 休講
  EXTRA      // 補講
}

////////////////////////////////////
// USER
////////////////////////////////////

model User {
  id             String   @id @default(uuid())

  attendanceNo   Int      @unique   // 出席番号（ログインID）
  nickname       String
  password       String   // ※後でハッシュ化

  role           Role     @default(STUDENT)

  attendances    Attendance[]
  grades         Grade[]
  subjectReports SubjectReport[]

  createdAt      DateTime @default(now())

  @@index([attendanceNo])
}

////////////////////////////////////
// SUBJECT
////////////////////////////////////

model Subject {
  id               String   @id @default(uuid())

  name             String
  credits          Int      // 単位数

  weekday          Int      // 0-6
  period           Int      // 1-6など

  isHalfCourse     Boolean  @default(false) // 学修単位フラグ

  testWeight       Float    // テスト割合（例: 70）
  reportWeight     Float    // 平常点割合（例: 30）

  totalTests       Int      // 年間テスト回数

  attendances      Attendance[]
  grades           Grade[]
  adjustments      ScheduleAdjustment[]
  subjectReports   SubjectReport[]

  createdAt        DateTime @default(now())

  @@index([weekday, period])
}

////////////////////////////////////
// ATTENDANCE（欠席記録）
////////////////////////////////////

model Attendance {
  id         String   @id @default(uuid())

  userId     String
  subjectId  String

  date       DateTime
  isDeleted  Boolean  @default(false) // 取消用（論理削除）

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject    Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@index([userId, subjectId])
  @@index([date])
}

////////////////////////////////////
// GRADE（テスト点）
////////////////////////////////////

model Grade {
  id         String   @id @default(uuid())

  userId     String
  subjectId  String

  testNumber Int      // 何回目のテストか
  score      Float    // テスト点

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject    Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@unique([userId, subjectId, testNumber]) // 同じテスト番号重複防止
  @@index([userId, subjectId])
}

////////////////////////////////////
// SUBJECT REPORT（平常点）
////////////////////////////////////

model SubjectReport {
  id         String   @id @default(uuid())

  userId     String
  subjectId  String

  reportScore Float   // 平常点（最終評価用）

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject    Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([userId, subjectId])
}

////////////////////////////////////
// SCHEDULE ADJUSTMENT（休講・補講）
////////////////////////////////////

model ScheduleAdjustment {
  id         String         @id @default(uuid())

  subjectId  String
  type       AdjustmentType
  date       DateTime

  subject    Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@index([subjectId])
  @@index([date])
}